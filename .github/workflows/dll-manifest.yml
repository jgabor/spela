name: Check DLSS Updates

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dll_type: [dlss, dlssg, dlssd]
        include:
          - dll_type: dlss
            filename: nvngx_dlss.dll
            name: DLSS
          - dll_type: dlssg
            filename: nvngx_dlssg.dll
            name: DLSS Frame Generation
          - dll_type: dlssd
            filename: nvngx_dlssd.dll
            name: DLSS Ray Reconstruction
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false

      - name: Build checker tool
        run: go build -o dlss-updater ./tools/dlss-updater

      - name: Check for ${{ matrix.name }} updates
        id: check
        run: |
          set +e
          OUTPUT=$(./dlss-updater -json -type ${{ matrix.dll_type }} -manifest data/manifest.json 2>&1)
          EXIT_CODE=$?
          set -e

          JSON_OUTPUT=$(echo "$OUTPUT" | grep -E '^\{' | head -1)
          if [ -z "$JSON_OUTPUT" ]; then
            JSON_OUTPUT="$OUTPUT"
          fi

          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$JSON_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
            VERSION=$(echo "$JSON_OUTPUT" | jq -r '.version')
            DOWNLOAD_URL=$(echo "$JSON_OUTPUT" | jq -r '.download_url')
            FILENAME=$(echo "$JSON_OUTPUT" | jq -r '.filename')
            SOURCE=$(echo "$JSON_OUTPUT" | jq -r '.source')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
            echo "filename=$FILENAME" >> $GITHUB_OUTPUT
            echo "source=$SOURCE" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Download ${{ matrix.name }}
        if: steps.check.outputs.has_update == 'true'
        run: |
          mkdir -p dist

          curl -L -A "Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0" \
            -o dist/dll_download.zip "${{ steps.check.outputs.download_url }}"

          cd dist
          unzip dll_download.zip

          FILENAME="${{ steps.check.outputs.filename }}"
          find . -name "$FILENAME" -exec cp {} downloaded.dll \;

          if [ ! -f downloaded.dll ]; then
            echo "ERROR: Could not find $FILENAME in downloaded archive"
            exit 1
          fi

          ls -la downloaded.dll

      - name: Calculate checksums
        if: steps.check.outputs.has_update == 'true'
        id: sha
        run: |
          SHA256=$(sha256sum dist/downloaded.dll | cut -d' ' -f1)
          SIZE=$(stat -c%s dist/downloaded.dll)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Create release and update manifest
        if: steps.check.outputs.has_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          DLL_TYPE="${{ matrix.dll_type }}"
          FILENAME="${{ matrix.filename }}"
          TAG="dll-${DLL_TYPE}-v${VERSION}"
          SHA256="${{ steps.sha.outputs.sha256 }}"
          SIZE="${{ steps.sha.outputs.size }}"
          SOURCE="${{ steps.check.outputs.source }}"
          NAME="${{ matrix.name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create tag if it doesn't exist
          if ! git ls-remote --tags origin | grep -q "refs/tags/$TAG"; then
            git tag -a "$TAG" -m "$NAME $VERSION"
            git push origin "$TAG"
          fi

          # Create release if it doesn't exist
          if ! gh release view "$TAG" &>/dev/null; then
            cp dist/downloaded.dll "dist/$FILENAME"
            gh release create "$TAG" "dist/$FILENAME" \
              --title "$NAME v$VERSION" \
              --notes "$NAME $VERSION

          **Source:** $SOURCE
          **SHA256:** \`$SHA256\`
          **Size:** $SIZE bytes"
          fi

          # Update manifest
          python3 << EOF
          import json
          from datetime import datetime, timezone

          with open('data/manifest.json', 'r') as f:
              manifest = json.load(f)

          new_dll = {
              'version': '$VERSION',
              'filename': '$FILENAME',
              'url': 'https://github.com/${{ github.repository }}/releases/download/$TAG/$FILENAME',
              'sha256': '$SHA256',
              'size': int('$SIZE'),
              'release_date': datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),
              'notes': 'From $SOURCE'
          }

          if '$DLL_TYPE' not in manifest['dlls']:
              manifest['dlls']['$DLL_TYPE'] = []

          manifest['dlls']['$DLL_TYPE'] = [d for d in manifest['dlls']['$DLL_TYPE'] if d['version'] != '$VERSION']
          manifest['dlls']['$DLL_TYPE'].insert(0, new_dll)
          manifest['updated_at'] = datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')

          with open('data/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          EOF

      - name: Commit manifest update
        if: steps.check.outputs.has_update == 'true'
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          DLL_TYPE="${{ matrix.dll_type }}"
          NAME="${{ matrix.name }}"

          git add data/manifest.json
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore: add $NAME $VERSION to manifest"

          # Retry push with rebase up to 5 times to handle parallel job races
          for i in 1 2 3 4 5; do
            if git push origin main; then
              echo "Push succeeded"
              exit 0
            fi
            echo "Push failed, retrying with rebase (attempt $i)..."
            git fetch origin main
            git rebase origin/main
          done

          echo "Failed to push after 5 attempts"
          exit 1

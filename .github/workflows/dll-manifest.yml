name: Check DLSS Updates

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build checker tool
        run: go build -o dlss-updater ./tools/dlss-updater

      - name: Check for DLSS updates
        id: check
        run: |
          set +e
          OUTPUT=$(./dlss-updater -json -manifest data/manifest.json)
          EXIT_CODE=$?
          set -e

          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
            VERSION=$(echo "$OUTPUT" | jq -r '.version')
            DOWNLOAD_URL=$(echo "$OUTPUT" | jq -r '.download_url')
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Download DLSS SDK
        if: steps.check.outputs.has_update == 'true'
        run: |
          mkdir -p dist
          curl -L -o dist/dlss_sdk.zip "${{ steps.check.outputs.download_url }}"
          cd dist
          unzip dlss_sdk.zip
          # Extract the DLL from the SDK demo
          find . -name "nvngx_dlss.dll" -exec cp {} dlss.dll \;
          ls -la dlss.dll

      - name: Calculate checksums
        if: steps.check.outputs.has_update == 'true'
        id: sha
        run: |
          SHA256=$(sha256sum dist/dlss.dll | cut -d' ' -f1)
          SIZE=$(stat -c%s dist/dlss.dll)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Create release and update manifest
        if: steps.check.outputs.has_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          TAG="dll-dlss-v$VERSION"
          SHA256="${{ steps.sha.outputs.sha256 }}"
          SIZE="${{ steps.sha.outputs.size }}"

          # Create tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "DLSS $VERSION"
          git push origin "$TAG"

          # Create release with the DLL renamed to nvngx_dlss.dll
          cp dist/dlss.dll dist/nvngx_dlss.dll
          gh release create "$TAG" dist/nvngx_dlss.dll \
            --title "DLSS v$VERSION" \
            --notes "DLSS $VERSION from official NVIDIA SDK

          **Source:** [NVIDIA/DLSS](https://github.com/NVIDIA/DLSS/releases/tag/v$VERSION)
          **SHA256:** \`$SHA256\`
          **Size:** $SIZE bytes"

          # Update manifest
          python3 << EOF
          import json
          from datetime import datetime, timezone

          with open('data/manifest.json', 'r') as f:
              manifest = json.load(f)

          new_dll = {
              'version': '$VERSION',
              'filename': 'nvngx_dlss.dll',
              'url': 'https://github.com/${{ github.repository }}/releases/download/$TAG/nvngx_dlss.dll',
              'sha256': '$SHA256',
              'size': int('$SIZE'),
              'release_date': datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),
              'notes': 'From official NVIDIA SDK'
          }

          if 'dlss' not in manifest['dlls']:
              manifest['dlls']['dlss'] = []

          manifest['dlls']['dlss'] = [d for d in manifest['dlls']['dlss'] if d['version'] != '$VERSION']
          manifest['dlls']['dlss'].insert(0, new_dll)
          manifest['updated_at'] = datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')

          with open('data/manifest.json', 'w') as f:
              json.dump(manifest, f, indent=2)
          EOF

      - name: Create pull request
        if: steps.check.outputs.has_update == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.check.outputs.version }}"
          BRANCH="dlss-update-$VERSION"

          git checkout -b "$BRANCH"
          git add data/manifest.json
          git commit -m "chore: add DLSS $VERSION to manifest"
          git push origin "$BRANCH"

          gh pr create \
            --title "chore: add DLSS $VERSION to manifest" \
            --body "Automated PR to add DLSS $VERSION to the DLL manifest.

          **Source:** [NVIDIA/DLSS](https://github.com/NVIDIA/DLSS/releases/tag/v$VERSION)
          **SHA256:** \`${{ steps.sha.outputs.sha256 }}\`

          The GitHub Release has been created with the DLL asset." \
            --base main \
            --head "$BRANCH"
